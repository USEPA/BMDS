image: python:3.9-slim

stages:
  - compile

package:
  stage: compile
  tags:
    - devsecops-instance
  script: |
    # install things we need
    apt-get update -y
    apt-get install -y automake build-essential libtool make cmake libgslcblas0 libgsl-dev

    # build eigen
    cd /builds/ord-heead/bmds/bmds-core
    cp vendor/eigen-3.4.0.tar.gz ./eigen-3.4.0.tar.gz
    tar -xvf eigen-3.4.0.tar.gz
    cd eigen-3.4.0 && mkdir build && cd build && cmake .. && make install && cd /

    # build nlopt
    cd /builds/ord-heead/bmds/bmds-core
    cp vendor/v2.7.1.tar.gz ./v2.7.1.tar.gz
    tar -xvf \v2.7.1.tar.gz
    cd nlopt-2.7.1/ && mkdir build && cd build && cmake .. && make install

    # remove these builds
    cd /builds/ord-heead/bmds/bmds-core
    rm -rf ./eigen-3.4.0 ./eigen-3.4.0.tar.gz ./nlopt-2.7.1/ ./v2.7.1.tar.gz

    # build bmds
    export "LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH"
    mkdir -p ../BMD_DLL_COMPILE
    ./create_dll_compile.bash
    cd ../BMD_DLL_COMPILE
    make
    make install
    ls -laht

  # artifacts:
  #   paths:
  #     - dist/*.whl
