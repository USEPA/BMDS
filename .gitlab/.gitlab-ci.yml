image: python:3.9-slim

stages:
  - compile

package:
  stage: compile
  tags:
    - devsecops-instance
  script: |
    # install
    apt-get update -y
    apt-get install -y automake build-essential libtool make cmake libgslcblas0 libgsl-dev wget

    # build 3rd party
    cd ~
    wget https://github.com/stevengj/nlopt/archive/v2.7.1.tar.gz
    wget https://gitlab.com/libeigen/eigen/-/archive/3.4.0/eigen-3.4.0.tar.gz
    # untar
    tar -xvf v2.7.1.tar.gz
    tar -xvf eigen-3.4.0.tar.gz
    # build
    cd ~/nlopt-2.7.1 && mkdir build && cd build && cmake .. && make install
    cd ~/eigen-3.4.0 && mkdir build && cd build && cmake .. && make install
    # cleanup
    cd ~
    rm -rf v2.7.1.tar.gz eigen-3.4.0.tar.gz nlopt-2.7.1 eigen-3.4.0

    # build bmds
    cd /builds/ord-heead/bmds/bmds-core
    export "LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH"
    mkdir -p ../BMD_DLL_COMPILE
    cp ./.gitlab/create_dll_compile.bash.template ./create_dll_compile.bash
    chmod 700 ./create_dll_compile.bash
    ./create_dll_compile.bash
    cd ../BMD_DLL_COMPILE
    make -j$(nproc)
    strip --strip-all ./.libs/libDRBMD.so.0.0.0

    # copy
    mkdir -p /builds/ord-heead/bmds/bmds-core/libs
    cp /builds/ord-heead/bmds/BMD_DLL_COMPILE/.libs/* ../bmds-core/libs

  artifacts:
    paths:
      - libs/*.so

